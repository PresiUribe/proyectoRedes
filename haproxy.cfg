global
    log stdout format raw local0

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  30s
    timeout server  30s

frontend http-in
    bind *:8080
    acl is_usuarios      path_beg /usuarios
    acl is_pagos         path_beg /pagos
    acl is_reservas      path_beg /reservas
    acl is_propiedades   path_beg /propiedades

    use_backend usuarios_back     if is_usuarios
    use_backend pagos_back        if is_pagos
    use_backend reservas_back     if is_reservas
    use_backend propiedades_back  if is_propiedades

    default_backend usuarios_back  # fallback

backend usuarios_back
    balance roundrobin
    option httpchk GET /health
    option http-server-close
    server-template user 3 usuario_ms:3000 resolvers docker check

backend pagos_back
    balance roundrobin
    option httpchk GET /health
    option http-server-close
    server-template pago 3 pagos_ms:3000 resolvers docker check

backend reservas_back
    balance roundrobin
    option httpchk GET /health
    option http-server-close
    server-template reserva 3 reservas_ms:3000 resolvers docker check

backend propiedades_back
    balance roundrobin
    option httpchk GET /health
    option http-server-close
    server-template propiedad 3 propiedades_ms:3000 resolvers docker check

resolvers docker
    nameserver dns 127.0.0.11:53
    resolve_retries 3
    timeout retry   1s
    timeout resolve 1s

listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats;csv
    stats refresh 10s
    # stats auth admin:admin
