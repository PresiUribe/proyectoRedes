const mysql = require('mysql2/promise');

// Configuración de la conexión a la base de datos
const connection = mysql.createPool({
    host: process.env.DB_HOST || 'localhost',
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || 'mysql',
    database: process.env.DB_NAME || 'propiedadesMS'
});

// Obtener todas las propiedades con filtros opcionales
// Filtros esperados:
//   filtros.ciudad -> city
//   filtros.cuartos -> bedrooms_count
//   filtros.precio_min -> average_rate_per_night >= ...
//   filtros.precio_max -> average_rate_per_night <= ...
async function traerPropiedades(filtros) {
    let query = 'SELECT * FROM propiedades WHERE 1';
    let params = [];

    if (filtros.ciudad) {
        query += ' AND city = ?';
        params.push(filtros.ciudad);
    }
    if (filtros.cuartos) {
        query += ' AND bedrooms_count = ?';
        params.push(filtros.cuartos);
    }
    if (filtros.precio_min) {
        query += ' AND average_rate_per_night >= ?';
        params.push(filtros.precio_min);
    }
    if (filtros.precio_max) {
        query += ' AND average_rate_per_night <= ?';
        params.push(filtros.precio_max);
    }

    const [rows] = await connection.query(query, params);
    return rows;
}

// Obtener la información de una propiedad por su ID
async function traerPropiedad(id) {
    const [rows] = await connection.query('SELECT * FROM propiedades WHERE id = ?', [id]);
    return rows;  // rows será un array de resultados
}

// Crear una nueva propiedad
// Recibe 8 parámetros, uno para cada columna (exceptuando el id autoincrement):
// average_rate, bedrooms, city, date, desc, lat, long, title
async function crearPropiedad(
    average_rate_per_night,
    bedrooms_count,
    city,
    date_of_listing,
    description,
    latitude,
    longitude,
    title
) {
    const [result] = await connection.query(
        `INSERT INTO propiedades
         VALUES (NULL, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
            average_rate_per_night,
            bedrooms_count,
            city,
            date_of_listing,
            description,
            latitude,
            longitude,
            title
        ]
    );
    return result;  // result.insertId contiene el id generado
}

// Actualizar una propiedad existente
// Actualiza las 8 columnas según su id
async function actualizarPropiedad(
    id,
    average_rate_per_night,
    bedrooms_count,
    city,
    date_of_listing,
    description,
    latitude,
    longitude,
    title
) {
    const [result] = await connection.query(
        `UPDATE propiedades
         SET average_rate_per_night = ?,
             bedrooms_count = ?,
             city = ?,
             date_of_listing = ?,
             description = ?,
             latitude = ?,
             longitude = ?,
             title = ?
         WHERE id = ?`,
        [
            average_rate_per_night,
            bedrooms_count,
            city,
            date_of_listing,
            description,
            latitude,
            longitude,
            title,
            id
        ]
    );
    return result;
}

// Eliminar una propiedad por su ID
async function borrarPropiedad(id) {
    const [result] = await connection.query('DELETE FROM propiedades WHERE id = ?', [id]);
    return result;
}

// En propiedadesModel.js
async function actualizarDisponibilidad(id, disponible) {
  const [result] = await connection.query(
    'UPDATE propiedades SET disponible = ? WHERE id = ?',
    [disponible, id]
  );
  return result;
}


module.exports = {
    traerPropiedades,
    traerPropiedad,
    crearPropiedad,
    actualizarPropiedad,
    borrarPropiedad,
    actualizarDisponibilidad
};
